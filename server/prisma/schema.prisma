// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ======================================================================================================
// PLAYER
// ======================================================================================================

model Player {
  id                    String                  @id @default(uuid())
  displayName           String                  @map("display_name")
  oauthProvider         String                  @map("oauth_provider")
  oauthId               String                  @map("oauth_id")
  createdAt             DateTime                @default(now()) @map("created_at")
  lastActiveAt          DateTime                @updatedAt @map("last_active_at")

  buildings             Building[]

  @@unique([oauthProvider, oauthId])
  @@map("players")
}

// ======================================================================================================
// GAME WORLD
// ======================================================================================================

model GameWorld {
  id                    String                  @id @default(uuid())
  name                  String
  status                String                  @default("active")
  createdAt             DateTime                @default(now()) @map("created_at")
  completedAt           DateTime?               @map("completed_at")
  config                Json

  fortresses            Fortress[]
  buildingTypes         BuildingType[]

  @@map("game_worlds")
}

// ======================================================================================================
// FORTRESS
// ======================================================================================================

model Fortress {
  id                    String              @id @default(uuid())
  gameWorldId           String              @map("game_world_id")
  name                  String
  positionX             Float               @map("position_x")
  positionY             Float               @map("position_y")
  owner                 String              @default("enemy")
  parentId              String?             @map("parent_id")
  captureThreshold      Int                 @map("capture_threshold")
  difficultyTier        Int                 @map("difficulty_tier")
  capturedAt            DateTime            @default(now()) @map("captured_at")

  gameWorld             GameWorld           @relation(fields: [gameWorldId], references: [id])
  parent                Fortress?           @relation("FortressTree", fields: [parentId], references: [id])
  children              Fortress[]          @relation("FortressTree")

  buildings             Building[]

  @@map("fortresses")
}

// ======================================================================================================
// BuildingType
// ======================================================================================================

model BuildingType {
  id                    String              @id @default(uuid())
  gameWorldId           String              @map("game_world_id")
  name                  String
  productionRate        Float               @map("production_rate")
  unlockTier            Int                 @map("unlock_tier")
  description           String

  gameWorld             GameWorld           @relation(fields: [gameWorldId], references: [id])
  buildings             Building[]

  @@map("building_types")
}

// ======================================================================================================
// Building
// ======================================================================================================

model Building {
  id                    String              @id @default(uuid())
  fortressId            String              @map("fortress_id")
  buildingTypeId        String              @map("building_type_id")
  builtBy               String              @map("built_by")
  builtAt               DateTime            @default(now()) @map("built_at")
  unitCount             Int                 @default(0) @map("unit_count")

  fortress              Fortress            @relation(fields: [fortressId], references: [id])
  buildingType          BuildingType        @relation(fields: [buildingTypeId], references: [id])
  player                Player              @relation(fields: [builtBy], references: [id])

  @@map("buildings")
}